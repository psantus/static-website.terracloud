Aujourdâ€™hui, je vais expliquer comment dÃ©ployer une passerelle PowerBI fiable et fonctionnelle. En cadeau, des extraits de code et un repo GitHub pour dÃ©ployer le tout en 5min avec Terraform ğŸ™‚

# PowerBI: dÃ©ployer une passerelle sur AWS pour $0.12/j

## Aujourdâ€™hui, je vais expliquer comment dÃ©ployer une passerelle PowerBI fiable et fonctionnelle. En cadeau, des extraits de code et un repo GitHub pour dÃ©ployer le tout en 5min avec Terraform ğŸ™‚

## Quâ€™est-ce quâ€™une passerelle de donnÃ©es locale PowerBI ? A quoi sert-elle ?

Pourquoi, me demandez-vous, auriez vous mÃªme besoin de PowerBI si vous avez Ã  dispo le cloud AWS et son offre complÃ¨te de services autour de la *data* (*pour en nommer quelques-uns: Glue pour lâ€™ETL, S3 pour le stockage, Athena pour requÃªter en SQL, Redshift pour lâ€™entrepÃ´t et Quicksight pour la data visualisation*) ? Bon.. vous savez que tout le monde aime Excel? Eh bien, PowerBI est le nouvel Excel ğŸ™‚ Sa capacitÃ© Ã  fournir de beaux graphiques (*si vous avez bossÃ© chez un Ã©diteur de logiciel, vous savez dâ€™expÃ©rience quâ€™aucun soft ne se vend sans dashboard, mÃªme si personne ne les utilise Ã  la fin)* Ã  partir de fichiers .xlsx locaux et de base de donnÃ©es fait croire aux utilisateurs que le data management est chose simple (en mettant sous le tapis les difficultÃ©s liÃ©es au data lineage, au cataloging et des difficutlÃ©s â€œmineuresâ€ comme la scalabilitÃ©, la securitÃ© et la gouvernance). Donc vos donnÃ©es sont dans le cloud, et quelquâ€™un veut les analyser avec Power BI. Bon professionnel que vous Ãªtes, vous ne les laissez pas exÃ©cuter de requÃªtes en direct sur la BDD de prod (que celui qui nâ€™a jamais pÃ©chÃ©â€¦). Voici donc Ã  quoi sert la â€œ*Passerelles de donnÃ©es locale PowerBIâ€ !* - La [passerelle sert de proxy](https://learn.microsoft.com/en-us/data-integration/gateway/service-gateway-onprem#how-the-gateway-works) sortant entre votre BDD et le service PowerBI, ce qui limite le besoin de monter un lien rÃ©seau entre le service/Azure (ou les utilisateurs) et la base de donnÃ©es   - Si vous ne controllez pas ce que les utilisateurs vont faire dans PowerBI, je vous recommande dâ€™Ã©viter le mode *Direct Query *et de paramÃ©trer une synchronisation pÃ©riodique des donnÃ©es dans ce que PowerBI appelle un *Dataflow* (câ€™est un stockage local au service que les utilisateurs vont attaquer).

## Voici ce que nous allons dÃ©ployer

Le code dans le repo Ã  la fin de cet article dÃ©ploie ce qui suit :

![](/images/blog/architecture-diagram-1024x420.png)

Pourquoi dÃ©ployer la Data gateway dans un AutoscalingGroup EC2 ? - **Le coÃ»t **(et lâ€™empreinte environnementale) : lâ€™ASG permet de **planifier la crÃ©ation/suppression **de notre instance EC2. Pour faire une synchro incrÃ©mentale, nous avons juste besoin de booter lâ€™instance quelques minutes avant le dÃ©clenchement du job de synchro et de lâ€™Ã©teindre aprÃ¨s. Dans notre cas, jâ€™utilise aussi une **requÃªte spot** qui permet encore de rÃ©duire le coÃ»t de ~30%.. je vais peut-Ãªtre louper un cycle de synchro si AWS nâ€™a pas de ressource dispo (REX : en 4 mois, jâ€™ai eu 2 cycles manquÃ©s). Une m5a.large (type dâ€™instance qui correspond aux exigences assez Ã©levÃ©es de Microsoft pour ce cas dâ€™usage) qui tourne 3 fois par jour pendant 20 minutes me coÃ»tera $0.12/j soit moins de $50. - **FiabilitÃ© sans maintenance**: lâ€™instance dÃ©marre chaque fois de la mÃªme image. De cette faÃ§on, je nâ€™aurai jamais de souci de type disque plein, fuite mÃ©moire, Windows qui ralentit (oui, la passerelle *doit* tourner sous Windows server). Un des principes devops (Pets vs. Cattle) est de considÃ©rer les machines comme dispensables! Puisque les experts PowerBI mâ€™ont indiquÃ© que la Passerelle aura besoin de [mises Ã  jour rÃ©guliÃ¨res](https://learn.microsoft.com/en-us/data-integration/gateway/service-gateway-monthly-updates) pour suivre le cycle de release de PowerBI, mon archi initiale impliquait un pipeline [EC2 Image Builder](https://aws.amazon.com/fr/image-builder/) pour gÃ©nÃ©rer une image machine en combinant *a. *la derniÃ¨re image (AMI) Windows *b. *la derniÃ¨re version du package dâ€™installation de passarelle PowerBI, et *c. *un script dâ€™installation-configuration de la passerelle. Pauvre fou! Ce serait espÃ©rer que Microsoft fournisse un produit fini, installable de faÃ§on silencieuse. Au risque de vous dÃ©cevoir : - MÃªme si [Microsoft a publiÃ© un module Powershell](https://community.powerbi.com/t5/Community-Blog/Data-Gateway-Automation-using-PowerShell-Part-1/ba-p/1117330) pour automatiser le setup, les cmdlets quâ€™il propose permettent uniquement de crÃ©er un nouveau cluster mais **pas dâ€™enregistrer une nouvelle machine comme participante dâ€™un cluster existant. **Autant pour lâ€™idempotence. - La passerelle dÃ©pend de drivers tiers. Le driver pour PostgreSQL est npgsql (dans une version assez obsolÃ¨te, la 4.0.10) qui doit Ãªtre installÃ©e avec une option non active par default (Global Assembly Cache, ou GAC) **qui ne peut lâ€™Ãªtre via une installation silencieuse.** Au temps pour lâ€™automatisation. Pour ces raisons, jâ€™ai dÃ» me rÃ©soudre Ã  devoir gÃ©nÃ©rer lâ€™image Windows manuellement.

## DÃ©ployer lâ€™infrastructure

Lâ€™infra elle-mÃªme est relativement simple. Dans le model Autoscaling : - On dÃ©finit le planning de crÃ©ation/destruction

- On dit quâ€™on prend des instances au prix spot

- On donne Ã  lâ€™instance un rÃ´le qui permet de sâ€™y connecter en RDP via AWS Systems Manager

- On sâ€™assure que lâ€™instance peut joindre tant la BDD que le service PowerBI.

Et voilÃ  ! Un code Terraform pleinement fonctionnel est dispo sur mon compte Github : [https://github.com/psantus/powerbi-onpremises-data-gateway.terraform](https://github.com/psantus/powerbi-onpremises-data-gateway.terraform) DÃ©ployez le dans un premier temps avec lâ€™AMI Windows standard. Puis aprÃ¨s avoir fait le setup initial dÃ©crit ci-dessous, faites un snapshot de la VM et dites Ã  lâ€™AutoScaling Group de lâ€™utiliser pour les dÃ©ploiments suivants.

## Installation de la passerelle de donnÃ©es PowerBI

AprÃ¨s que vous avez dÃ©ployÃ© lâ€™image Windows standard, vous pouvez suivre les Ã©tapes suivantes pour installer les paquets de la passerelle PowerBI Gateway et les configurer ainsi que le service PowerBI. - Connectez vous Ã  la machine via AWS Systems Manager Installez Powershell 7 (seule version compatible avec le module DataGateway) : ``` msiexec.exe /package https://github.com/PowerShell/PowerShell/releases/download/v7.2.6/PowerShell-7.2.6-win-x64.msi /quiet ADD_EXPLORER_CONTEXT_MENU_OPENPOWERSHELL=1 ADD_FILE_CONTEXT_MENU_RUNPOWERSHELL=1 ENABLE_PSREMOTING=1 REGISTER_MANIFEST=1 USE_MU=1 ENABLE_MU=1 ADD_PATH=1 ``` Lancez une session PowerShell 7 puis installez le module DataGateway ``` pwsh Install-Module DataGateway -Force Import-Module DataGateway -Force ``` - CrÃ©ez une application sur lâ€™Azure AD. Pour ce faire vous devez Ãªtre admin Azure AD. Lâ€™App doit avoir les permissions Tenant.ReadWrite.All sur le service PowerBI. ![](/images/blog/17_FTwaUiKdkp97I4LGcX3g-300x155.png) GÃ©nÃ©rez un secret. Notez les Ã©lÃ©ments suivants pour la suite:  â€“ App secret  â€“ ClientID â€“ TenantID - Connectez vous sur le service PowerBI avec lâ€™App que vous venez de crÃ©er : (ici je suppose que le secret a Ã©tÃ© collÃ© dans un fichier nommÃ© Â« secret.txt Â» sur le Bureau - nâ€™oubliez pas de le supprimer aprÃ¨s !) ``` # Set secret in a secure string $secureClientSecret = (cat .\Desktop\secret.txt | ConvertTo-SecureString -AsPlainText -Force) # Connect to the PowerBI Service Connect-DataGatewayServiceAccount -ApplicationId $AppId -ClientSecret $secureClientSecret -Tenant $TenantId ``` - Installez le paquet de la passerelle PowerBI ``` Install-DataGateway -AcceptConditions # Restart the service after installation (removes some random errors) net stop PBIEgwService net start PBIEgwService ``` - Installez le driver Postgres Npgsql v4.0.10. Seule cette version fonctionne (elle doit sâ€™appuyer sur la mÃªme version de .NET que lâ€™application PowerBI Gateway, cf. Microsoft site). Quand vous lancez le MSI, assurez-vous de cocher Â« Npgsql GAC Installation Â». - CrÃ©ez une Passerelle de donnÃ©es sur le service PowerBI et configurez lâ€™application pour crÃ©er un cluster: ``` $GateWayDetails = Add-DataGatewayCluster -GatewayName "My Gateway" -RecoveryKey $secureClientSecret -OverwriteExistingGateway # Get gateways and find the one you just created Get-DataGatewayCluster # Put its detail in a variable $GateWayDetails = Get-DataGatewayCluster -Id "xxxxxx-xxxxxx-xxxxxx-xxxxx" ``` - Donnez des droits dâ€™admin sur la passerelle Ã  un utilisateur (ou un groupe) ``` Add-DataGatewayClusterUser -GatewayClusterId $GateWayDetails.Id -PrincipalObjectId "Azure AD User or Group ID here" -AllowedDataSourceTypes $null -Role Admin ``` - DÃ©sormais, vous devriez voir la passerelle dans lâ€™interface web PowerBI Gateway [https://app.powerbi.com/groups/me/gateways](https://app.powerbi.com/groups/me/gateways) - (Nb : vous pouvez donner des permissions plus limitÃ©es sur la gateway, par exemple juste la possibilitÃ© de se connecter Ã  une BDD PostgreSQL mais pas dâ€™autres sources de donnÃ©es) ``` $dsTypes = New-Object 'System.Collections.Generic.List[Microsoft.PowerBI.ServiceContracts.Api.DatasourceType]' $dsTypes.Add([Microsoft.PowerBI.ServiceContracts.Api.DataSourceType]::PostgreSql) Add-DataGatewayClusterUser -GatewayClusterId $GateWayDetails.Id -PrincipalObjectId "Azure AD User or Group ID here" -AllowedDataSourceTypes $dsTypes -Role ConnectionCreator ```

## Ressources

le code Terraform dÃ©montrÃ© dans ce post est dispo dans un repo sur mon compte Github [https://github.com/psantus/powerbi-onpremises-data-gateway.terraform](https://github.com/psantus/powerbi-onpremises-data-gateway.terraform) Si vous avez trouvÃ© ce post utile, ou que vous avez la bontÃ© de suggÃ©rer des amÃ©liorations (câ€™est mon premier post de blog, jâ€™imagine donc quâ€™il est largement perfectible),nâ€™hÃ©sitez pas Ã  laisser un commentaire!